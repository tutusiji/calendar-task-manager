# 全景视图组织管理功能

## 修改日期
2025-12-06

## 功能概述

为超级管理员全景视图添加了组织的编辑和删除功能，允许管理员直接在全景视图中管理组织。

## 新增功能

### 1. 编辑组织
- **触发方式**：鼠标悬停在组织卡片上，点击右上角的三点菜单，选择"编辑"
- **可编辑内容**：
  - 组织名称
  - 认证状态（已认证/未认证）
- **验证规则**：
  - 组织名称不能为空
  - 组织名称不能与其他组织重复
- **实时更新**：编辑成功后，组织列表和详情页会立即更新

### 2. 删除组织
- **触发方式**：鼠标悬停在组织卡片上，点击右上角的三点菜单，选择"删除"
- **删除限制**：
  - 只能删除没有成员、团队和项目的空组织
  - 如果组织中还有数据，会提示错误信息
- **确认对话框**：删除前会弹出确认对话框，防止误操作
- **实时更新**：删除成功后，组织会从列表中移除

## 技术实现

### 新增文件

#### 1. API 路由：`app/api/admin/panorama/organizations/[id]/route.ts`

**PUT 端点** - 更新组织信息
```typescript
PUT /api/admin/panorama/organizations/[id]
Body: {
  name?: string,
  isVerified?: boolean
}
```

**功能**：
- 验证组织是否存在
- 检查新名称是否重复
- 更新组织信息
- 返回更新后的组织数据（包含统计信息）

**DELETE 端点** - 删除组织
```typescript
DELETE /api/admin/panorama/organizations/[id]
```

**功能**：
- 验证组织是否存在
- 检查组织是否为空（无成员、团队、项目）
- 删除组织
- 返回成功消息

### 修改文件

#### 1. 全景视图组件：`components/admin/panorama-view.tsx`

**新增导入**：
```typescript
import { Pencil, Trash2, MoreVertical } from "lucide-react"
import { DropdownMenu, Input, Label, Checkbox, AlertDialog } from "@/components/ui/*"
```

**新增状态**：
```typescript
// 编辑组织对话框状态
const [editDialogOpen, setEditDialogOpen] = useState(false)
const [editingOrg, setEditingOrg] = useState<Organization | null>(null)
const [editOrgName, setEditOrgName] = useState("")
const [editOrgVerified, setEditOrgVerified] = useState(false)
const [editLoading, setEditLoading] = useState(false)

// 删除组织确认对话框状态
const [deleteDialogOpen, setDeleteDialogOpen] = useState(false)
const [deletingOrg, setDeletingOrg] = useState<Organization | null>(null)
const [deleteLoading, setDeleteLoading] = useState(false)
```

**新增方法**：
- `handleEditOrg(org)` - 打开编辑对话框
- `handleSaveOrg()` - 保存组织修改
- `handleDeleteOrg(org)` - 打开删除确认对话框
- `confirmDeleteOrg()` - 确认删除组织

**UI 改进**：
- 组织卡片添加 `group` 类，实现悬停效果
- 添加三点菜单按钮（悬停时显示）
- 菜单包含"编辑"和"删除"选项

## 用户界面

### 组织卡片
```
┌─────────────────────────────────────┐
│ 组织名称              已认证  [⋮]   │
│ 10 成员  5 团队  8 项目             │
│ 25 个事项                           │
└─────────────────────────────────────┘
         ↓ 悬停显示菜单
┌─────────────────────────────────────┐
│ 组织名称              已认证  [⋮]   │
│                            ┌──────┐ │
│                            │ 编辑 │ │
│                            │ 删除 │ │
│                            └──────┘ │
└─────────────────────────────────────┘
```

### 编辑对话框
```
┌──────────────────────────────────┐
│ 编辑组织                    [×]  │
├──────────────────────────────────┤
│ 修改组织的基本信息               │
│                                  │
│ 组织名称                         │
│ [输入框]                         │
│                                  │
│ ☑ 已认证组织                    │
│                                  │
│              [取消]  [保存]      │
└──────────────────────────────────┘
```

### 删除确认对话框
```
┌──────────────────────────────────┐
│ 确认删除组织                     │
├──────────────────────────────────┤
│ 确定要删除组织「XXX」吗？        │
│ 注意：只有没有成员、团队和       │
│ 项目的组织才能被删除。           │
│                                  │
│              [取消]  [确认删除]  │
└──────────────────────────────────┘
```

## 交互流程

### 编辑组织流程
1. 鼠标悬停在组织卡片上
2. 点击右上角的三点菜单按钮
3. 选择"编辑"
4. 在对话框中修改组织名称或认证状态
5. 点击"保存"
6. 系统验证并更新组织信息
7. 成功后关闭对话框，列表自动更新

### 删除组织流程
1. 鼠标悬停在组织卡片上
2. 点击右上角的三点菜单按钮
3. 选择"删除"
4. 在确认对话框中查看警告信息
5. 点击"确认删除"
6. 系统检查组织是否为空
7. 如果为空，删除成功，从列表中移除
8. 如果不为空，显示错误提示

## 错误处理

### 编辑组织错误
- **组织名称为空**：保存按钮禁用
- **组织名称重复**：显示错误提示"组织名称已被使用"
- **组织不存在**：显示错误提示"组织不存在"
- **网络错误**：显示错误提示"更新组织失败"

### 删除组织错误
- **组织不存在**：显示错误提示"组织不存在"
- **组织不为空**：显示错误提示"无法删除：组织中还有成员、团队或项目。请先清空组织后再删除。"
- **网络错误**：显示错误提示"删除组织失败"

## 安全考虑

1. **权限验证**：
   - 只有超级管理员可以访问全景视图
   - 需要通过 panorama_auth 验证

2. **数据完整性**：
   - 删除前检查组织是否为空
   - 防止误删除有数据的组织

3. **名称唯一性**：
   - 编辑时检查名称是否重复
   - 保证组织名称的唯一性

4. **事件阻止**：
   - 菜单按钮点击时阻止事件冒泡
   - 防止触发组织选择事件

## 测试场景

### 场景 1：编辑组织名称
1. 打开全景视图
2. 悬停在组织卡片上
3. 点击三点菜单 → 编辑
4. 修改组织名称
5. 点击保存
6. ✅ 组织名称更新成功
7. ✅ 列表中的组织名称立即更新

### 场景 2：修改认证状态
1. 打开编辑对话框
2. 勾选/取消勾选"已认证组织"
3. 点击保存
4. ✅ 认证状态更新成功
5. ✅ 卡片上的"已认证"标签显示/隐藏

### 场景 3：删除空组织
1. 选择一个没有成员、团队、项目的组织
2. 点击三点菜单 → 删除
3. 在确认对话框中点击"确认删除"
4. ✅ 组织删除成功
5. ✅ 从列表中移除

### 场景 4：尝试删除非空组织
1. 选择一个有成员/团队/项目的组织
2. 点击三点菜单 → 删除
3. 在确认对话框中点击"确认删除"
4. ✅ 显示错误提示
5. ✅ 组织未被删除

### 场景 5：名称重复验证
1. 编辑组织A
2. 将名称改为已存在的组织B的名称
3. 点击保存
4. ✅ 显示错误提示"组织名称已被使用"
5. ✅ 组织未被更新

## 注意事项

1. **删除限制**：
   - 必须先清空组织中的所有成员、团队和项目
   - 才能删除组织
   - 这是为了防止数据丢失

2. **实时更新**：
   - 编辑或删除后，列表会立即更新
   - 如果当前选中的组织被编辑，详情页也会更新
   - 如果当前选中的组织被删除，会清空详情页

3. **悬停交互**：
   - 三点菜单按钮只在悬停时显示
   - 使用 `opacity-0 group-hover:opacity-100` 实现
   - 提供更清爽的界面

4. **加载状态**：
   - 保存和删除时显示加载动画
   - 按钮禁用，防止重复提交
   - 提供良好的用户反馈

## 相关文件

### 新增文件
- `app/api/admin/panorama/organizations/[id]/route.ts` - 组织操作 API

### 修改文件
- `components/admin/panorama-view.tsx` - 全景视图组件

## 未来改进

1. **批量操作**：
   - 支持批量删除空组织
   - 支持批量修改认证状态

2. **更多编辑选项**：
   - 添加组织描述字段
   - 添加组织图标/Logo

3. **删除前清空**：
   - 提供"清空并删除"选项
   - 自动移除所有成员、团队、项目后删除组织

4. **操作日志**：
   - 记录组织的编辑和删除操作
   - 提供审计追踪
